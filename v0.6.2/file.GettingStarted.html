<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta name="Content-Type" content="text/html; charset=utf-8" />
<title>File: GettingStarted</title>
<link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '';
  if (relpath != '') relpath += '/';
</script>
<script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="js/app.js"></script>

  </head>
  <body>
    
    <!-- GOOGLE ANALYTICS -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-16382932-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
    <!-- *************** -->
    
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header" class="clearfix">
      
      <div id="logo">DRAGONFLY (v 0.6.2)</div>
      <div id="search">
  <a id="class_list_link" href="#">Class List</a>
  <a id="method_list_link" href="#">Method List</a>
  <a id ="file_list_link" href="#">File List</a>
</div>

    </div>
    
    <div>
      <iframe id="search_frame"></iframe>
    </div>
    
    <div id="content" class="clearfix">
      <div class="col1">
        <div id='filecontents'><h1>Getting Started</h1>

<p>Below is a general guide for setting up and using Dragonfly.</p>

<p>For setting up with Ruby on Rails, see <a href="file.UsingWithRails.html" title="UsingWithRails">UsingWithRails</a>.</p>

<p>For more info about using Rack applications, see the docs at <a href="http://rack.rubyforge.org/" target="_parent" title="http://rack.rubyforge.org/">http://rack.rubyforge.org/</a></p>

<h2>Running as a Standalone Rack Application</h2>

<p>Basic usage of a dragonfly app involves storing data (e.g. images),
then serving that data, either in its original form, processed, encoded or both.</p>

<p>A basic rackup file <code>config.ru</code>:</p>

<pre class="code"><span class='id require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>rubygems</span><span class='tstring_end'>'</span></span>
<span class='id require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>dragonfly</span><span class='tstring_end'>'</span></span>

<span class='const'>Dragonfly</span><span class='op'>::</span><span class='const'>App</span><span class='lbracket'>[</span><span class='symbol'>:my_app_name</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id configure'>configure</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id c'>c</span><span class='op'>|</span>
  <span class='comment'># ...
</span>  <span class='id c'>c</span><span class='period'>.</span><span class='id some_attribute'>some_attribute</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>blah</span><span class='tstring_end'>'</span></span>
  <span class='comment'># ...
</span><span class='kw'>end</span>

<span class='id run'>run</span> <span class='label'>Dragonfly:</span><span class='const'>App</span><span class='lbracket'>[</span><span class='symbol'>:my_app_name</span><span class='rbracket'>]</span>
</pre>

<p>As you can see, this involves instantiating an app, configuring it (how data is stored,
processing, encoding, etc.), then running it.</p>

<p>You can have multiple dragonfly apps, each with their own configuration.
Each app has a name, and is referred to by that name.</p>

<pre class="code"><span class='const'>Dragonfly</span><span class='op'>::</span><span class='const'>App</span><span class='lbracket'>[</span><span class='symbol'>:images</span><span class='rbracket'>]</span>    <span class='comment'># ===&gt; Creates an app called 'images'
</span><span class='const'>Dragonfly</span><span class='op'>::</span><span class='const'>App</span><span class='lbracket'>[</span><span class='symbol'>:images</span><span class='rbracket'>]</span>    <span class='comment'># ===&gt; Refers to the already created app 'images'
</span></pre>

<h2>Example: Using to serve resized images</h2>

<p><code>config.ru</code>:</p>

<pre class="code"><span class='id require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>rubygems</span><span class='tstring_end'>'</span></span>
<span class='id require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>dragonfly</span><span class='tstring_end'>'</span></span>
<span class='id require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>rack/cache</span><span class='tstring_end'>'</span></span>

<span class='id app'>app</span> <span class='op'>=</span> <span class='const'>Dragonfly</span><span class='op'>::</span><span class='const'>App</span><span class='lbracket'>[</span><span class='symbol'>:images</span><span class='rbracket'>]</span>
<span class='id app'>app</span><span class='period'>.</span><span class='id configure_with'>configure_with</span><span class='lparen'>(</span><span class='const'>Dragonfly</span><span class='op'>::</span><span class='const'>Config</span><span class='op'>::</span><span class='const'>RMagickImages</span><span class='rparen'>)</span>

<span class='id use'>use</span> <span class='const'>Rack</span><span class='op'>::</span><span class='const'>Cache</span><span class='comma'>,</span>
  <span class='symbol'>:verbose</span>     <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='symbol'>:metastore</span>   <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>file:/var/cache/rack/meta</span><span class='tstring_end'>'</span></span><span class='comma'>,</span>
  <span class='symbol'>:entitystore</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>file:/var/cache/rack/body</span><span class='tstring_end'>'</span></span>

<span class='id run'>run</span> <span class='id app'>app</span>
</pre>

<p>This configures the app to use the RMagick <tt><a href="Dragonfly/Processing/RMagickProcessor.html" title="Dragonfly::Processing::RMagickProcessor (class)">processor</a></tt>,
<tt><a href="Dragonfly/Encoding/RMagickEncoder.html" title="Dragonfly::Encoding::RMagickEncoder (class)">encoder</a></tt> and <tt><a href="Dragonfly/Analysis/RMagickAnalyser.html" title="Dragonfly::Analysis::RMagickAnalyser (class)">analyser</a></tt>.
By default the <tt><a href="Dragonfly/DataStorage/FileDataStore.html" title="Dragonfly::DataStorage::FileDataStore (class)">file data store</a></tt> is used.</p>

<p>Elsewhere in our code:</p>

<pre class="code"><span class='id app'>app</span> <span class='op'>=</span> <span class='const'>Dragonfly</span><span class='op'>::</span><span class='const'>App</span><span class='lbracket'>[</span><span class='symbol'>:images</span><span class='rbracket'>]</span>

<span class='comment'># Store
</span><span class='id uid'>uid</span> <span class='op'>=</span> <span class='id app'>app</span><span class='period'>.</span><span class='id store'>store</span><span class='lparen'>(</span><span class='const'>File</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>path/to/image.png</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='rparen'>)</span>   <span class='comment'># ===&gt; returns a unique uid for that image, &quot;2009/11/29/145804_file&quot;
</span>
<span class='comment'># Get the url for a thumbnail
</span><span class='id url'>url</span> <span class='op'>=</span> <span class='id app'>app</span><span class='period'>.</span><span class='id url_for'>url_for</span><span class='lparen'>(</span><span class='id uid'>uid</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>30x30</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='symbol'>:gif</span><span class='rparen'>)</span>            <span class='comment'># ===&gt; &quot;/2009/11/29/145804_file.gif?m=resize&amp;o[geometry]=30x30&quot;
</span></pre>

<p>Now when we visit the url <code>/2009/11/29/145804_file.gif?m=resize&amp;o[geometry]=30x30</code> in the browser, we get the resized
image!</p>

<h2>Caching</h2>

<p>Processing and encoding can be an expensive operation. The first time we visit the url,
the image is processed, and there might be a short delay and getting the response.</p>

<p>However, dragonfly apps send <code>Cache-Control</code> and <code>ETag</code> headers in the response, so we can easily put a caching
proxy like <a href="http://varnish.projects.linpro.no" target="_parent" title="Varnish">Varnish</a>, <a href="http://www.squid-cache.org" target="_parent" title="Squid">Squid</a>,
<a href="http://tomayko.com/src/rack-cache/" target="_parent" title="Rack::Cache">Rack::Cache</a>, etc. in front of the app.</p>

<p>In the example above, we've put the middleware <a href="http://tomayko.com/src/rack-cache/" target="_parent" title="Rack::Cache">Rack::Cache</a> in front of the app.
So although the first time we access the url the content is processed, every time after that it is received from the
cache, and is served super quick!</p>

<h2>Avoiding Denial-of-service attacks</h2>

<p>The url given above, <code>/2009/11/29/145804_file.gif?m=resize&amp;o[geometry]=30x30</code>, could easily be modified to
generate all different sizes of thumbnails, just by changing the size, e.g.</p>

<p><code>/2009/11/29/145804_file.gif?m=resize&amp;o[geometry]=30x31</code>,</p>

<p><code>/2009/11/29/145804_file.gif?m=resize&amp;o[geometry]=30x32</code>,</p>

<p>etc.</p>

<p>Therefore the app can protect the url by generating a unique sha from a secret specified by you</p>

<pre class="code"><span class='const'>Dragonfly</span><span class='op'>::</span><span class='const'>App</span><span class='lbracket'>[</span><span class='symbol'>:images</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id url_handler'>url_handler</span><span class='period'>.</span><span class='id configure'>configure</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id c'>c</span><span class='op'>|</span>
  <span class='id c'>c</span><span class='period'>.</span><span class='id protect_from_dos_attacks'>protect_from_dos_attacks</span> <span class='op'>=</span> <span class='kw'>true</span>                           <span class='comment'># Actually this is true by default
</span>  <span class='id c'>c</span><span class='period'>.</span><span class='id secret'>secret</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>You should supply some random secret here</span><span class='tstring_end'>'</span></span>
<span class='kw'>end</span>
</pre>

<p>Then the required urls become something more like</p>

<p><code>/2009/12/10/215214_file.gif?m=resize&amp;o[geometry]=30x30&amp;s=aa78e877ad3f6bc9</code>,</p>

<p>with a sha parameter on the end.
If we try to hack this url to get a different thumbnail,</p>

<p><code>/2009/12/10/215214_file.gif?m=resize&amp;o[geometry]=30x31&amp;s=aa78e877ad3f6bc9</code>,</p>

<p>then we get a 400 (bad parameters) error.</p></div>
      </div>
      <div class="col2">
        <ul class="main_files clearfix">
          <li><a href="file.README.html" title="Quick start for Rails (README)">Quick start for Rails (README)</a></li><li><a href="file.GettingStarted.html" title="Getting started">Getting started</a></li><li><a href="file.UsingWithRails.html" title="Using with Rails">Using with Rails</a></li><li><a href="file.ActiveRecord.html" title="Using with ActiveRecord">Using with ActiveRecord</a></li><li><a href="file.DataStorage.html" title="Data Storage">Data Storage</a></li><li><a href="file.Analysers.html" title="Analysers">Analysers</a></li><li><a href="file.Processing.html" title="Processing">Processing</a></li><li><a href="file.Encoding.html" title="Encoding">Encoding</a></li><li><a href="file.Shortcuts.html" title="Shortcuts for processing and encoding">Shortcuts for processing and encoding</a></li><li><a href="file.MimeTypes.html" title="Mime Types">Mime Types</a></li><li><a href="file.ExampleUseCases.html" title="Example use cases">Example use cases</a></li><li><a href="file.History.html" title="History">History</a></li>
        </ul>
      </div>
    </div>
    
    <div id="footer">
  Generated on Wed Aug 25 00:53:43 2010 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool">yard</a>
  0.5.8 (ruby-1.9.2).
</div>

  </body>
</html>
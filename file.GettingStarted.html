<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta name="Content-Type" content="text/html; charset=UTF-8" />
<title>File: GettingStarted</title>
<link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '';
  if (relpath != '') relpath += '/';
</script>
<script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="js/app.js"></script>

  </head>
  <body>
    
    <!-- GOOGLE ANALYTICS -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-16382932-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
    <!-- *************** -->
    
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header" class="clearfix">
      
      <div id="logo">DRAGONFLY (v 0.6.2)</div>
      <div id="search">
  <a id="class_list_link" href="#">Class List</a>
  <a id="method_list_link" href="#">Method List</a>
  <a id ="file_list_link" href="#">File List</a>
</div>

    </div>
    
    <div>
      <iframe id="search_frame"></iframe>
    </div>
    
    <div id="content" class="clearfix">
      <div class="col1">
        <div id='filecontents'><h1>Getting Started</h1>

<p>Below is a general guide for setting up and using Dragonfly.</p>

<p>For setting up with Ruby on Rails, see <a href="file.UsingWithRails.html" title="UsingWithRails">UsingWithRails</a>.</p>

<p>For more info about using Rack applications, see the docs at <a href="http://rack.rubyforge.org/" target="_parent" title="http://rack.rubyforge.org/">http://rack.rubyforge.org/</a></p>

<h2>Running as a Standalone Rack Application</h2>

<p>Basic usage of a dragonfly app involves storing data (e.g. images),
then serving that data, either in its original form, processed, encoded or both.</p>

<p>A basic rackup file <code>config.ru</code>:</p>

<pre class="code"><span class='require identifier id'>require</span> <span class='string val'>'rubygems'</span>
<span class='require identifier id'>require</span> <span class='string val'>'dragonfly'</span>

<span class='Dragonfly constant id'>Dragonfly</span><span class='colon2 op'>::</span><span class='App constant id'>App</span><span class='lbrack token'>[</span><span class='symbol val'>:my_app_name</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='configure identifier id'>configure</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='c identifier id'>c</span><span class='bitor op'>|</span>
  <span class='comment val'># ...</span>
  <span class='c identifier id'>c</span><span class='dot token'>.</span><span class='some_attribute identifier id'>some_attribute</span> <span class='assign token'>=</span> <span class='string val'>'blah'</span>
  <span class='comment val'># ...</span>
<span class='end end kw'>end</span>

<span class='run identifier id'>run</span> <span class='Dragonfly constant id'>Dragonfly</span><span class='symbol val'>:App</span><span class='lbrack token'>[</span><span class='symbol val'>:my_app_name</span><span class='rbrack token'>]</span>
</pre>

<p>As you can see, this involves instantiating an app, configuring it (how data is stored,
processing, encoding, etc.), then running it.</p>

<p>You can have multiple dragonfly apps, each with their own configuration.
Each app has a name, and is referred to by that name.</p>

<pre class="code"><span class='Dragonfly constant id'>Dragonfly</span><span class='colon2 op'>::</span><span class='App constant id'>App</span><span class='lbrack token'>[</span><span class='symbol val'>:images</span><span class='rbrack token'>]</span>    <span class='comment val'># ===&gt; Creates an app called 'images'</span>
<span class='Dragonfly constant id'>Dragonfly</span><span class='colon2 op'>::</span><span class='App constant id'>App</span><span class='lbrack token'>[</span><span class='symbol val'>:images</span><span class='rbrack token'>]</span>    <span class='comment val'># ===&gt; Refers to the already created app 'images'</span>
</pre>

<h2>Example: Using to serve resized images</h2>

<p><code>config.ru</code>:</p>

<pre class="code"><span class='require identifier id'>require</span> <span class='string val'>'rubygems'</span>
<span class='require identifier id'>require</span> <span class='string val'>'dragonfly'</span>
<span class='require identifier id'>require</span> <span class='string val'>'rack/cache'</span>

<span class='app identifier id'>app</span> <span class='assign token'>=</span> <span class='Dragonfly constant id'>Dragonfly</span><span class='colon2 op'>::</span><span class='App constant id'>App</span><span class='lbrack token'>[</span><span class='symbol val'>:images</span><span class='rbrack token'>]</span>
<span class='app identifier id'>app</span><span class='dot token'>.</span><span class='configure_with identifier id'>configure_with</span><span class='lparen token'>(</span><span class='Dragonfly constant id'>Dragonfly</span><span class='colon2 op'>::</span><span class='Config constant id'>Config</span><span class='colon2 op'>::</span><span class='RMagickImages constant id'>RMagickImages</span><span class='rparen token'>)</span>

<span class='use identifier id'>use</span> <span class='Rack constant id'>Rack</span><span class='colon2 op'>::</span><span class='Cache constant id'>Cache</span><span class='comma token'>,</span>
  <span class='symbol val'>:verbose</span>     <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span><span class='comma token'>,</span>
  <span class='symbol val'>:metastore</span>   <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'file:/var/cache/rack/meta'</span><span class='comma token'>,</span>
  <span class='symbol val'>:entitystore</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'file:/var/cache/rack/body'</span>

<span class='run identifier id'>run</span> <span class='app identifier id'>app</span>
</pre>

<p>This configures the app to use the RMagick <tt><a href="Dragonfly/Processing/RMagickProcessor.html" title="Dragonfly::Processing::RMagickProcessor (class)">processor</a></tt>,
<tt><a href="Dragonfly/Encoding/RMagickEncoder.html" title="Dragonfly::Encoding::RMagickEncoder (class)">encoder</a></tt> and <tt><a href="Dragonfly/Analysis/RMagickAnalyser.html" title="Dragonfly::Analysis::RMagickAnalyser (class)">analyser</a></tt>.
By default the <tt><a href="Dragonfly/DataStorage/FileDataStore.html" title="Dragonfly::DataStorage::FileDataStore (class)">file data store</a></tt> is used.</p>

<p>Elsewhere in our code:</p>

<pre class="code"><span class='app identifier id'>app</span> <span class='assign token'>=</span> <span class='Dragonfly constant id'>Dragonfly</span><span class='colon2 op'>::</span><span class='App constant id'>App</span><span class='lbrack token'>[</span><span class='symbol val'>:images</span><span class='rbrack token'>]</span>

<span class='comment val'># Store</span>
<span class='uid identifier id'>uid</span> <span class='assign token'>=</span> <span class='app identifier id'>app</span><span class='dot token'>.</span><span class='store identifier id'>store</span><span class='lparen token'>(</span><span class='File constant id'>File</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='string val'>'path/to/image.png'</span><span class='rparen token'>)</span><span class='rparen token'>)</span>   <span class='comment val'># ===&gt; returns a unique uid for that image, &quot;2009/11/29/145804_file&quot;</span>

<span class='comment val'># Get the url for a thumbnail</span>
<span class='url identifier id'>url</span> <span class='assign token'>=</span> <span class='app identifier id'>app</span><span class='dot token'>.</span><span class='url_for identifier id'>url_for</span><span class='lparen token'>(</span><span class='uid identifier id'>uid</span><span class='comma token'>,</span> <span class='string val'>'30x30'</span><span class='comma token'>,</span> <span class='symbol val'>:gif</span><span class='rparen token'>)</span>            <span class='comment val'># ===&gt; &quot;/2009/11/29/145804_file.gif?m=resize&amp;o[geometry]=30x30&quot;</span>
</pre>

<p>Now when we visit the url <code>/2009/11/29/145804_file.gif?m=resize&amp;o[geometry]=30x30</code> in the browser, we get the resized
image!</p>

<h2>Caching</h2>

<p>Processing and encoding can be an expensive operation. The first time we visit the url,
the image is processed, and there might be a short delay and getting the response.</p>

<p>However, dragonfly apps send <code>Cache-Control</code> and <code>ETag</code> headers in the response, so we can easily put a caching
proxy like <a href="http://varnish.projects.linpro.no" target="_parent" title="Varnish">Varnish</a>, <a href="http://www.squid-cache.org" target="_parent" title="Squid">Squid</a>,
<a href="http://tomayko.com/src/rack-cache/" target="_parent" title="Rack::Cache">Rack::Cache</a>, etc. in front of the app.</p>

<p>In the example above, we've put the middleware <a href="http://tomayko.com/src/rack-cache/" target="_parent" title="Rack::Cache">Rack::Cache</a> in front of the app.
So although the first time we access the url the content is processed, every time after that it is received from the
cache, and is served super quick!</p>

<h2>Avoiding Denial-of-service attacks</h2>

<p>The url given above, <code>/2009/11/29/145804_file.gif?m=resize&amp;o[geometry]=30x30</code>, could easily be modified to
generate all different sizes of thumbnails, just by changing the size, e.g.</p>

<p><code>/2009/11/29/145804_file.gif?m=resize&amp;o[geometry]=30x31</code>,</p>

<p><code>/2009/11/29/145804_file.gif?m=resize&amp;o[geometry]=30x32</code>,</p>

<p>etc.</p>

<p>Therefore the app can protect the url by generating a unique sha from a secret specified by you</p>

<pre class="code"><span class='Dragonfly constant id'>Dragonfly</span><span class='colon2 op'>::</span><span class='App constant id'>App</span><span class='lbrack token'>[</span><span class='symbol val'>:images</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='url_handler identifier id'>url_handler</span><span class='dot token'>.</span><span class='configure identifier id'>configure</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='c identifier id'>c</span><span class='bitor op'>|</span>
  <span class='c identifier id'>c</span><span class='dot token'>.</span><span class='protect_from_dos_attacks identifier id'>protect_from_dos_attacks</span> <span class='assign token'>=</span> <span class='true true kw'>true</span>                           <span class='comment val'># Actually this is true by default</span>
  <span class='c identifier id'>c</span><span class='dot token'>.</span><span class='secret identifier id'>secret</span> <span class='assign token'>=</span> <span class='string val'>'You should supply some random secret here'</span>
<span class='end end kw'>end</span>
</pre>

<p>Then the required urls become something more like</p>

<p><code>/2009/12/10/215214_file.gif?m=resize&amp;o[geometry]=30x30&amp;s=aa78e877ad3f6bc9</code>,</p>

<p>with a sha parameter on the end.
If we try to hack this url to get a different thumbnail,</p>

<p><code>/2009/12/10/215214_file.gif?m=resize&amp;o[geometry]=30x31&amp;s=aa78e877ad3f6bc9</code>,</p>

<p>then we get a 400 (bad parameters) error.</p>
</div>
      </div>
      <div class="col2">
        <ul class="main_files clearfix">
          <li><a href="file.README.html" title="Quick start for Rails (README)">Quick start for Rails (README)</a></li><li><a href="file.GettingStarted.html" title="Getting started">Getting started</a></li><li><a href="file.UsingWithRails.html" title="Using with Rails">Using with Rails</a></li><li><a href="file.ActiveRecord.html" title="Using with ActiveRecord">Using with ActiveRecord</a></li><li><a href="file.DataStorage.html" title="Data Storage">Data Storage</a></li><li><a href="file.Analysers.html" title="Analysers">Analysers</a></li><li><a href="file.Processing.html" title="Processing">Processing</a></li><li><a href="file.Encoding.html" title="Encoding">Encoding</a></li><li><a href="file.Shortcuts.html" title="Shortcuts for processing and encoding">Shortcuts for processing and encoding</a></li><li><a href="file.MimeTypes.html" title="Mime Types">Mime Types</a></li><li><a href="file.ExampleUseCases.html" title="Example use cases">Example use cases</a></li><li><a href="file.History.html" title="History">History</a></li>
        </ul>
      </div>
    </div>
    
    <div id="footer">
  Generated on Thu Jun 24 15:25:58 2010 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool">yard</a>
  0.5.3 (ruby-1.8.7).
</div>

  </body>
</html>
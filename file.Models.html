<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta name="Content-Type" content="text/html; charset=utf-8" />
<title>File: Models</title>
<link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '';
  if (relpath != '') relpath += '/';
</script>
<script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="js/app.js"></script>

  </head>
  <body>

    <!-- GOOGLE ANALYTICS -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-16382932-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
    <!-- *************** -->

    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>

    <div id="header" class="clearfix">
      
      <div id="logo">DRAGONFLY (v 0.7.7)</div>
      <div id="search">
  <a id="class_list_link" href="#">Class List</a>
  <a id="method_list_link" href="#">Method List</a>
  <a id ="file_list_link" href="#">File List</a>
</div>

    </div>

    <div>
      <iframe id="search_frame"></iframe>
    </div>

    <div id="content" class="clearfix">
      <div class="col1">
        <div id='filecontents'><h1>Using with Models</h1>

<p>You can extend ActiveModel-compatible models to make working with content such as images
as easy as working with strings or numbers!</p>

<p>The examples below assume an initialized Dragonfly app, e.g.</p>

<pre class="code"><span class='id app'>app</span> <span class='op'>=</span> <span class='const'>Dragonfly</span><span class='lbracket'>[</span><span class='symbol'>:images</span><span class='rbracket'>]</span>
</pre>

<h2>ActiveRecord</h2>

<p>If you've required 'dragonfly/rails/images', then the following step will be already done for you.
Otherwise:</p>

<pre class="code"><span class='id app'>app</span><span class='period'>.</span><span class='id define_macro'>define_macro</span><span class='lparen'>(</span><span class='const'>ActiveRecord</span><span class='op'>::</span><span class='const'>Base</span><span class='comma'>,</span> <span class='symbol'>:image_accessor</span><span class='rparen'>)</span>
</pre>

<p>defines the macro <code>image_accessor</code> on any ActiveRecord models.</p>

<h2>Mongoid</h2>

<pre class="code"><span class='id app'>app</span><span class='period'>.</span><span class='id define_macro_on_include'>define_macro_on_include</span><span class='lparen'>(</span><span class='const'>Mongoid</span><span class='op'>::</span><span class='const'>Document</span><span class='comma'>,</span> <span class='symbol'>:image_accessor</span><span class='rparen'>)</span>
</pre>

<p>defines the macro <code>image_accessor</code> on any models that include <code>Mongoid::Document</code></p>

<h2>Adding accessors</h2>

<p>Now we have the method <code>image_accessor</code> available in our model classes, which we can use as many times as we like</p>

<pre class="code"><span class='kw'>class</span> <span class='const'>Album</span>
  <span class='id image_accessor'>image_accessor</span> <span class='symbol'>:cover_image</span>
  <span class='id image_accessor'>image_accessor</span> <span class='symbol'>:band_photo</span>  <span class='comment'># Note: this is a different image altogether, not a thumbnail of cover_image
</span><span class='kw'>end</span>
</pre>

<p>Each accessor (e.g. <code>cover_image</code>) depends on a string field to actually hold the datastore uid,
named by appending the suffix <code>_uid</code> (e.g. <code>cover_image_uid</code>).</p>

<p>For example, ActiveRecord models need a migration such as:</p>

<pre class="code"><span class='kw'>class</span> <span class='const'>MyMigration</span> <span class='op'>&lt;</span> <span class='const'>ActiveRecord</span><span class='op'>::</span><span class='const'>Migration</span>

  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id up'>up</span>
    <span class='id add_column'>add_column</span> <span class='symbol'>:albums</span><span class='comma'>,</span> <span class='symbol'>:cover_image_uid</span><span class='comma'>,</span> <span class='symbol'>:string</span>
    <span class='id add_column'>add_column</span> <span class='symbol'>:albums</span><span class='comma'>,</span> <span class='symbol'>:band_photo_uid</span><span class='comma'>,</span> <span class='symbol'>:string</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id down'>down</span>
    <span class='id remove_column'>remove_column</span> <span class='symbol'>:albums</span><span class='comma'>,</span> <span class='symbol'>:cover_image_uid</span>
    <span class='id remove_column'>remove_column</span> <span class='symbol'>:albums</span><span class='comma'>,</span> <span class='symbol'>:band_photo_uid</span>
  <span class='kw'>end</span>

<span class='kw'>end</span>
</pre>

<h2>Using the accessors</h2>

<p>We can use the attribute much like other other model attributes:</p>

<pre class="code"><span class='ivar'>@album</span> <span class='op'>=</span> <span class='const'>Album</span><span class='period'>.</span><span class='id new'>new</span>

<span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\377???JFIF\000\...</span><span class='tstring_end'>&quot;</span></span>             <span class='comment'># can assign as a string...
</span><span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>path/to/my_image.png</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>  <span class='comment'># ... or as a file...
</span><span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span> <span class='op'>=</span> <span class='id some_tempfile'>some_tempfile</span>                     <span class='comment'># ... or as a tempfile...
</span><span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span> <span class='op'>=</span> <span class='ivar'>@album</span><span class='period'>.</span><span class='id band_photo'>band_photo</span>                 <span class='comment'># ... or as another Dragonfly attachment
</span>
<span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span>          <span class='comment'># =&gt; #&lt;Dragonfly::ActiveModelExtensions::Attachment:0x103ef6128...
</span>
<span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span> <span class='op'>=</span> <span class='kw'>nil</span>
<span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span>          <span class='comment'># =&gt; nil
</span></pre>

<p>We can inspect properties of the attribute</p>

<pre class="code"><span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span><span class='period'>.</span><span class='id width'>width</span>                          <span class='comment'># =&gt; 280
</span><span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span><span class='period'>.</span><span class='id height'>height</span>                         <span class='comment'># =&gt; 140
</span><span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span><span class='period'>.</span><span class='id number_of_colours'>number_of_colours</span>              <span class='comment'># =&gt; 34703
</span><span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span><span class='period'>.</span><span class='id mime_type'>mime_type</span>                      <span class='comment'># =&gt; 'image/png'
</span></pre>

<p>The properties available (i.e. 'width', etc.) come from the app's registered analysers - see <a href="file.Analysers.html" title="Analysers">Analysers</a>.</p>

<p>We can play around with the data</p>

<pre class="code"><span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span><span class='period'>.</span><span class='id data'>data</span>                           <span class='comment'># =&gt; &quot;\377???JFIF\000\...&quot;
</span><span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span><span class='period'>.</span><span class='id to_file'>to_file</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>out.png</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>             <span class='comment'># writes to file 'out.png' and returns a readable file object
</span><span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span><span class='period'>.</span><span class='id tempfile'>tempfile</span>                       <span class='comment'># =&gt; #&lt;File:/var/folders/st/strHv74sH044JPabSiODz... a closed Tempfile object
</span><span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span><span class='period'>.</span><span class='id file'>file</span>                           <span class='comment'># =&gt; #&lt;File:/var/folders/st/strHv74sH044JPabSiODz... a readable (open) File object
</span><span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span><span class='period'>.</span><span class='id file'>file</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id f'>f</span><span class='op'>|</span>                    <span class='comment'># Yields an open file object, returns the return value of
</span>  <span class='id data'>data</span> <span class='op'>=</span> <span class='id f'>f</span><span class='period'>.</span><span class='id read'>read</span><span class='lparen'>(</span><span class='int'>256</span><span class='rparen'>)</span>                              <span class='comment'>#  the block, and closes the file object
</span><span class='kw'>end</span>
<span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span><span class='period'>.</span><span class='id path'>path</span>                           <span class='comment'># =&gt; '/var/folders/st/strHv74sH044JPabSiODz...' i.e. the path of the tempfile
</span><span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span><span class='period'>.</span><span class='id size'>size</span>                           <span class='comment'># =&gt; 134507 (size in bytes)
</span></pre>

<p>We can process the data</p>

<pre class="code"><span class='id image'>image</span> <span class='op'>=</span> <span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span><span class='period'>.</span><span class='id process'>process</span><span class='lparen'>(</span><span class='symbol'>:thumb</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>20x20</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>   <span class='comment'># returns a 'Job' object, with similar properties
</span><span class='id image'>image</span><span class='period'>.</span><span class='id width'>width</span>                                          <span class='comment'># =&gt; 20
</span><span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span><span class='period'>.</span><span class='id width'>width</span>                              <span class='comment'># =&gt; 280 (no change)
</span></pre>

<p>The available processing methods available (i.e. 'thumb', etc.) come from the <tt><a href="Dragonfly.html" title="Dragonfly (module)">Dragonfly</a></tt> app's registered processors - see <a href="file.Processing.html" title="Processing">Processing</a></p>

<p>We can encode the data</p>

<pre class="code"><span class='id image'>image</span> <span class='op'>=</span> <span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span><span class='period'>.</span><span class='id encode'>encode</span><span class='lparen'>(</span><span class='symbol'>:gif</span><span class='rparen'>)</span>   <span class='comment'># returns a 'Job' object, with similar properties
</span><span class='id image'>image</span><span class='period'>.</span><span class='id format'>format</span>                              <span class='comment'># =&gt; :gif
</span><span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span><span class='period'>.</span><span class='id format'>format</span>                 <span class='comment'># =&gt; :png (no change)
</span></pre>

<p>The encoding is implemented by the <tt><a href="Dragonfly.html" title="Dragonfly (module)">Dragonfly</a></tt> app's registered encoders (which will usually just be one) - see <a href="file.Encoding.html" title="Encoding">Encoding</a></p>

<p>We can use configured shortcuts for processing/encoding, and chain them:</p>

<pre class="code"><span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span><span class='period'>.</span><span class='id thumb'>thumb</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>300x200#ne</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>     <span class='comment'># =&gt; returns a 'Job' object, with similar properties
</span></pre>

<p>We can chain all these things much like ActiveRecord scopes:</p>

<pre class="code"><span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span><span class='period'>.</span><span class='id png'>png</span><span class='period'>.</span><span class='id thumb'>thumb</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>300x200#ne</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id process'>process</span><span class='lparen'>(</span><span class='symbol'>:greyscale</span><span class='rparen'>)</span><span class='period'>.</span><span class='id encode'>encode</span><span class='lparen'>(</span><span class='symbol'>:tiff</span><span class='rparen'>)</span>
</pre>

<p>Because the processing/encoding methods are lazy, no actual processing or encoding is done until a method like <code>data</code>, <code>file</code>, <code>to_file</code>, <code>width</code>, etc. is called.
You can force the processing to be done if you must by then calling <code>apply</code>.</p>

<pre class="code"><span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span><span class='period'>.</span><span class='id process'>process</span><span class='lparen'>(</span><span class='symbol'>:greyscale</span><span class='rparen'>)</span><span class='period'>.</span><span class='id apply'>apply</span>
</pre>

<h2>Persisting</h2>

<p>When the model is saved, a before_save callback persists the data to the <tt><a href="Dragonfly/App.html" title="Dragonfly::App (class)">App</a></tt>'s configured datastore (see <a href="file.DataStorage.html" title="DataStorage">DataStorage</a>)
The uid column is then filled in.</p>

<pre class="code"><span class='ivar'>@album</span> <span class='op'>=</span> <span class='const'>Album</span><span class='period'>.</span><span class='id new'>new</span>

<span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image_uid'>cover_image_uid</span>                                   <span class='comment'># =&gt; nil
</span>
<span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>path/to/my_image.png</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
<span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image_uid'>cover_image_uid</span>                                   <span class='comment'># =&gt; nil
</span>
<span class='ivar'>@album</span><span class='period'>.</span><span class='id save'>save</span>
<span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image_uid'>cover_image_uid</span>                                   <span class='comment'># =&gt; '2009/12/05/file.png' (some unique uid, used by the datastore)
</span></pre>

<h2>URLs</h2>

<p>Once the model is saved, we can get a url for the image (which is served by the Dragonfly <tt><a href="Dragonfly/App.html" title="Dragonfly::App (class)">App</a></tt> itself), and for its processed/encoded versions:</p>

<pre class="code"><span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span><span class='period'>.</span><span class='id url'>url</span>                           <span class='comment'># =&gt; '/media/BAhbBlsHOgZmIhgy...'
</span><span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span><span class='period'>.</span><span class='id thumb'>thumb</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>300x200#nw</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id url'>url</span>       <span class='comment'># =&gt; '/media/BAhbB1sYusgZhgyM...'
</span><span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span><span class='period'>.</span><span class='id process'>process</span><span class='lparen'>(</span><span class='symbol'>:greyscale</span><span class='rparen'>)</span><span class='period'>.</span><span class='id jpg'>jpg</span><span class='period'>.</span><span class='id url'>url</span>   <span class='comment'># =&gt; '/media/BnA6CnRodW1iIg8z...'
</span></pre>

<p>Because the processing/encoding methods (including shortcuts like <code>thumb</code> and <code>jpg</code>) are lazy, no processing or encoding is actually done.</p>

<h2>Validations</h2>

<p><code>validates_presence_of</code> and <code>validates_size_of</code> work out of the box, and Dragonfly also provides <code>validates_property</code>.</p>

<pre class="code"><span class='kw'>class</span> <span class='const'>Album</span>

  <span class='id validates_presence_of'>validates_presence_of</span> <span class='symbol'>:cover_image</span>
  <span class='id validates_size_of'>validates_size_of</span> <span class='symbol'>:cover_image</span><span class='comma'>,</span> <span class='symbol'>:maximum</span> <span class='op'>=&gt;</span> <span class='int'>500</span><span class='period'>.</span><span class='id kilobytes'>kilobytes</span>

  <span class='id validates_property'>validates_property</span> <span class='symbol'>:format</span><span class='comma'>,</span> <span class='symbol'>:of</span> <span class='op'>=&gt;</span> <span class='symbol'>:cover_image</span><span class='comma'>,</span> <span class='symbol'>:in</span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='symbol'>:jpeg</span><span class='comma'>,</span> <span class='symbol'>:png</span><span class='comma'>,</span> <span class='symbol'>:gif</span><span class='rbracket'>]</span>
  <span class='comment'># ..or..
</span>  <span class='id validates_property'>validates_property</span> <span class='symbol'>:mime_type</span><span class='comma'>,</span> <span class='symbol'>:of</span> <span class='op'>=&gt;</span> <span class='symbol'>:cover_image</span><span class='comma'>,</span> <span class='symbol'>:in</span> <span class='op'>=&gt;</span> <span class='qwords_beg'>%w(</span><span class='tstring_content'>image/jpeg</span><span class='words_sep'> </span><span class='tstring_content'>image/png</span><span class='words_sep'> </span><span class='tstring_content'>image/gif</span><span class='words_sep'>)</span>

  <span class='id validates_property'>validates_property</span> <span class='symbol'>:width</span><span class='comma'>,</span> <span class='symbol'>:of</span> <span class='op'>=&gt;</span> <span class='symbol'>:cover_image</span><span class='comma'>,</span> <span class='symbol'>:in</span> <span class='op'>=&gt;</span> <span class='lparen'>(</span><span class='int'>0</span><span class='op'>..</span><span class='int'>400</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='symbol'>:message</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>é demais cara!</span><span class='tstring_end'>&quot;</span></span>

  <span class='comment'># ...
</span><span class='kw'>end</span>
</pre>

<p>The property argument of <code>validates_property</code> will generally be one of the registered analyser properties as described in <a href="file.Analysers.html" title="Analysers">Analysers</a>.
However it would actually work for arbitrary properties, including those of non-dragonfly model attributes.</p>

<h2>Name and extension</h2>

<p>If the object assigned is a file, or responds to <code>original_filename</code> (as is the case with file uploads in Rails, etc.), then <code>name</code> will be set.</p>

<pre class="code"><span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>path/to/my_image.png</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>

<span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span><span class='period'>.</span><span class='id name'>name</span>    <span class='comment'># =&gt; 'my_image.png'
</span><span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span><span class='period'>.</span><span class='id ext'>ext</span>     <span class='comment'># =&gt; 'png'
</span></pre>

<h2>Meta data</h2>

<p>You can store metadata along with the content data of your attachment:</p>

<pre class="code"><span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>path/to/my_image.png</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
<span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span><span class='period'>.</span><span class='id meta'>meta</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='symbol'>:taken</span> <span class='op'>=&gt;</span> <span class='const'>Date</span><span class='period'>.</span><span class='id yesterday'>yesterday</span><span class='rbrace'>}</span>
<span class='ivar'>@album</span><span class='period'>.</span><span class='id save!'>save!</span>

<span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span><span class='period'>.</span><span class='id meta'>meta</span>      <span class='comment'># =&gt; {:model_class=&gt;&quot;Album&quot;,
</span>                             <span class='comment'>#     :model_attachment=&gt;:cover_image,
</span>                             <span class='comment'>#     :taken=&gt;Sat, 11 Sep 2010}
</span></pre>

<p>As you can see, a couple of things are added by the model. You can also access this directly on the <tt><a href="Dragonfly/Job.html" title="Dragonfly::Job (class)">Job</a></tt> object.</p>

<pre class="code"><span class='id app'>app</span><span class='period'>.</span><span class='id fetch'>fetch</span><span class='lparen'>(</span><span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image_uid'>cover_image_uid</span><span class='rparen'>)</span><span class='period'>.</span><span class='id meta'>meta</span>     <span class='comment'># =&gt; {:model_class=&gt;&quot;Album&quot;, ...}
</span></pre>

<h2>'Magic' Attributes</h2>

<p>An accessor like <code>cover_image</code> only relies on the accessor <code>cover_image_uid</code> to work.
However, in some cases you may want to record some other properties, whether it be for using in queries, or
for caching an attribute for performance reasons, etc.</p>

<p>For the properties <code>name</code>, <code>ext</code>, <code>size</code> and any of the registered analysis methods (e.g. <code>width</code>, etc. in the examples above),
this is done automatically for you, if the corresponding accessor exists.</p>

<p>For example - with ActiveRecord, given the migration:</p>

<pre class="code"><span class='id add_column'>add_column</span> <span class='symbol'>:albums</span><span class='comma'>,</span> <span class='symbol'>:cover_image_width</span><span class='comma'>,</span> <span class='symbol'>:integer</span>
</pre>

<p>This will automatically be set when assigned:</p>

<pre class="code"><span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>path/to/my_image.png</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>

<span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image_width'>cover_image_width</span>  <span class='comment'># =&gt; 280
</span></pre>

<p>They can be used to avoid retrieving data from the datastore for analysis</p>

<pre class="code"><span class='ivar'>@album</span> <span class='op'>=</span> <span class='const'>Album</span><span class='period'>.</span><span class='id first'>first</span>

<span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span><span class='period'>.</span><span class='id width'>width</span>     <span class='comment'># =&gt; 280    - no need to retrieve data - takes it from `cover_image_width`
</span><span class='ivar'>@album</span><span class='period'>.</span><span class='id cover_image'>cover_image</span><span class='period'>.</span><span class='id size'>size</span>      <span class='comment'># =&gt; 134507 - but this needs to retrieve data from the data store, then analyse
</span></pre>

<h2>Custom Model</h2>

<p>The accessors only require that your model class implements <code>before_save</code>, <code>before_destroy</code> and <code>validates_each</code>
(if using validations), as well as of course the <code>..._uid</code> field for storing the datastore uid.</p>

<p>Here is an example of a minimal ActiveModel <code>Album</code> model:</p>

<pre class="code"><span class='kw'>class</span> <span class='const'>CustomModel</span><span class='op'>::</span><span class='const'>Base</span>

  <span class='id extend'>extend</span> <span class='const'>ActiveModel</span><span class='op'>::</span><span class='const'>Callbacks</span>
  <span class='id define_model_callbacks'>define_model_callbacks</span> <span class='symbol'>:save</span><span class='comma'>,</span> <span class='symbol'>:destroy</span>

  <span class='id include'>include</span> <span class='const'>ActiveModel</span><span class='op'>::</span><span class='const'>Validations</span>   <span class='comment'># if needed
</span>
  <span class='kw'>def</span> <span class='id save'>save</span>
    <span class='id _run_save_callbacks'>_run_save_callbacks</span> <span class='lbrace'>{</span>
      <span class='comment'># do some saving!
</span>    <span class='rbrace'>}</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id destroy'>destroy</span>
    <span class='id _run_destroy_callbacks'>_run_destroy_callbacks</span> <span class='lbrace'>{</span>
      <span class='comment'># do some destroying!
</span>    <span class='rbrace'>}</span>
  <span class='kw'>end</span>

<span class='kw'>end</span>
</pre>

<p>Define our <code>image_accessor</code> macro...</p>

<pre class="code"><span class='id app'>app</span><span class='period'>.</span><span class='id define_macro'>define_macro</span><span class='lparen'>(</span><span class='const'>CustomModel</span><span class='op'>::</span><span class='const'>Base</span><span class='comma'>,</span> <span class='symbol'>:image_accessor</span><span class='rparen'>)</span>
</pre>

<p>...which is used by <code>Album</code>:</p>

<pre class="code"><span class='kw'>class</span> <span class='const'>Album</span> <span class='op'>&lt;</span> <span class='const'>CustomModel</span><span class='op'>::</span><span class='const'>Base</span>

  <span class='kw'>def</span> <span class='id cover_image_uid='>cover_image_uid=</span>
    <span class='comment'># ...
</span>  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id cover_image_uid'>cover_image_uid</span>
    <span class='comment'># ...
</span>  <span class='kw'>end</span>

  <span class='id image_accessor'>image_accessor</span> <span class='symbol'>:cover_image</span>

<span class='kw'>end</span>
</pre></div>
      </div>
      <div class="col2">
        <ul class="main_files clearfix">
          <li><a href="file.Index.html" title="Home">Home</a></li><li><a href="file.README.html" title="Quick start for Rails (README)">Quick start for Rails (README)</a></li><li><a href="file.GeneralUsage.html" title="General usage">General usage</a></li><li><a href="file.Rails2.html" title="Rails 2.3">Rails 2.3</a></li><li><a href="file.Rails3.html" title="Rails 3">Rails 3</a></li><li><a href="file.Models.html" title="Models (ActiveRecord, ActiveModel, etc.)">Models (ActiveRecord, ActiveModel, etc.)</a></li><li><a href="file.Rack.html" title="Rack">Rack</a></li><li><a href="file.Sinatra.html" title="Sinatra">Sinatra</a></li><li><a href="file.Heroku.html" title="Heroku">Heroku</a></li><li><a href="file.Mongo.html" title="Mongo">Mongo</a></li><li><a href="file.DataStorage.html" title="Data Storage">Data Storage</a></li><li><a href="file.Analysers.html" title="Analysers">Analysers</a></li><li><a href="file.Processing.html" title="Processing">Processing</a></li><li><a href="file.Encoding.html" title="Encoding">Encoding</a></li><li><a href="file.Generators.html" title="Generators">Generators</a></li><li><a href="file.Configuration.html" title="Configuration">Configuration</a></li><li><a href="file.URLs.html" title="URLs / Endpoints">URLs / Endpoints</a></li><li><a href="file.MimeTypes.html" title="Mime Types">Mime Types</a></li><li><a href="file.Caching.html" title="Caching">Caching</a></li><li><a href="file.History.html" title="History">History</a></li>
        </ul>
      </div>
    </div>

    <div id="footer">
  Generated on Sun Oct 31 01:10:39 2010 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool">yard</a>
  0.5.8 (ruby-1.9.2).
</div>

  </body>
</html>
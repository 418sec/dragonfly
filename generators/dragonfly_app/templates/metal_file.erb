# Allow the metal piece to run in isolation
require(File.dirname(__FILE__) + "/../../config/environment") unless defined?(Rails)
require 'dragonfly'

# Configuration of the Dragonfly App
Dragonfly::App[:<%= app_name %>].configure_with(RMagickConfiguration)
Dragonfly::App[:<%= app_name %>].configure do |c|
  c.log = RAILS_DEFAULT_LOGGER
  c.datastore.configure do |d|
    d.root_path = "#{Rails.root}/public/system/dragonfly/#{Rails.env}"
  end
  c.url_handler do |u|
    u.secret = '<%= random_secret %>'
    u.path_prefix = '/<%= path_prefix %>'
  end
end

# The metal, for running the app
app = Dragonfly::App[:<%= app_name %>]
<%= metal_name %> = Rack::Builder.new do

  # UNCOMMENT ME!!!
  # ... if you want to use super-dooper middleware 'rack-cache'
  # require 'rack/cache'
  # use Rack::Cache,
  #   :verbose     => true,
  #   :metastore   => 'file:/var/cache/rack/meta',
  #   :entitystore => 'file:/var/cache/rack/body'
  
  map app.url_handler.path_prefix do
    run app
  end
  
end
